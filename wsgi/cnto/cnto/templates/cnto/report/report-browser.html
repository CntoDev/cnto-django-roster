{% extends "cnto/report/base.html" %}
{% load staticfiles %}

{% block content %}
<div class="container col-md-10 col-md-offset-1">
    <div class="row">
        <div class='col-sm-2'>
            Month for report
        </div>
    </div>
    <div class="row">
        <div class='col-sm-2'>
            <div class="form-group">
                <div class='input-group date' id='month-picker'>
                    <input id='selected-date-text' type='text' class="form-control"/>
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
            </div>
        </div>
        <div class='col-sm-1'>
            <button id="generate-report" class="btn btn-primary">Generate</button>
        </div>
        <div class='col-sm-1'>
            <img id="generate-report-throbber" style="display: none;" src="{% static 'cnto/images/throbber.gif' %}">
        </div>
    </div>
    <div id="report-container" class="row">
    </div>
</div>
{% endblock %}

{% block js %}
<script type="text/template" id="report-body-template">
    <div id='report-body'>
        <h3><%= start_dt %> to <%= end_dt %></h3>
        <%= event_count %> events were recorded.
        <% if (event_count > 0) { %>
            <% _.each(attendances,function(group,group_name,arr) { %>
            <h4><%=group_name %></h4>
            <table class="table table-bordered">
                <tr>
                    <th>Member</th>
                    <% _.each(events.start_dates,function(event_start_date,key,arr) { %>
                    <th class="<%=events.css_classes[key] %>"><%=event_start_date %></th>
                    <% }); %>
                </tr>
                <% _.each(group,function(member,member_name,arr) { %>
                <tr <% if (member.attendance_adequate) { %>class="good-attendance-row"<% } else { %>class="bad-attendance-row"<% } %> >
                    <td><%=member_name %></td>
                    <% _.each(member.attendances,function(attend_status,key,arr) { %>
                        <td><%=attend_status %></td>
                    <% }); %>
                </tr>
                <% }); %>
            </table>
            <% }); %>
        <% } %>
    </div>
</script>

<script>
    $(document).ready(function () {
        $('#generate-report-throbber').hide();

        $("#month-picker").datetimepicker({
                                              defaultDate: moment().subtract(1, 'months'),
                                              viewMode: 'months',
                                                format: 'YYYY-MM'
                                          }
        );

        $('#generate-report').on('click', function (e) {
            $('#generate-report-throbber').show();
            var dateString = $("#selected-date-text").val();
            var reportUrl = "{% url 'get-report-body-for-month' '1234-56' %}".replace('1234-56', dateString);
            $.get(reportUrl, function (data) {
                $('#generate-report-throbber').hide();
                var tpl = _.template($("#report-body-template").html());
                $("#report-container").html(tpl(data));
            });
        });
    });



</script>
{% endblock %}
